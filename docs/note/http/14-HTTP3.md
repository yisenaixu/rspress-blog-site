# HTTP3

虽然HTTP2进行了很多优化，但是仍然有问题没有解决

- TCP造成的队头阻塞
- TCP/TLS握手时延
- 网络迁移重新连接

## TCP队头阻塞

TCP是通过字节流传输，必须保证字节数据完整有序，如果传输过程中发生丢包，则需要等待数据重传。

HTTP2多个流的帧乱序传递同一条TCP连接中，如果某一条流的帧在TCP传输时发生了丢失，则后续其他流的帧也都会阻塞，TCP必须等待数据重传，字节流完整时才能，才能使上层应用层获取到数据

## TCP三次握手，TLS四次握手

三个rtt的往返时延

## 网络迁移需要重新连接

TCP连接确立四元族：源IP，源端口，目标IP，目标端口

手机从wifi换成了4g网络环境，TCP和TLS就需要重新握手

## HTTP3的优化

显然以上问题都和TCP有关，想要解决问题就只能更换协议

**UDP,简单，不可靠传输的协议，不需要握手**,一定比TCP传输快

但TCP的特性依然需要，因此在应用层建立新的协议（QUIC）去实现TCP的特性

此外在报文（帧）的格式上，也进行变化（压缩帧头），因为HTTP3不在需要定义流，帧结构变的简单

### 动态表的优化

如果第一次请求丢包，客户端建立的动态表，但是服务端没有，那么第二次请求，客户端会发送动态表的索引，而服务端解析不出来，直到第一次请求重传过来

HTTP3采用特殊的单向流同步动态表

- 一个叫 QPACK Encoder Stream，用于将一个字典（Key-Value）传递给对方，比如面对不属于静态表的 HTTP 请求头部，客户端可以通过这个 Stream 发送字典；
- 一个叫 QPACK Decoder Stream，用于响应对方，告诉它刚发的字典已经更新到自己的本地动态表了，后续就可以使用这个字典来编码了。

## QUIC协议

- 无队头阻塞
- 更快的连接建立
- 连接迁移

### 无队头阻塞

QUIC标记一个流内每个数据包的序号，只要一个数据包丢失，后续数据包到达也不会被HTTP3读取

各个流之间没有依赖，某个流丢包只影响该流

### 更快的连接建立

TCP和TLS依次进行握手建立连接（因为在不同层），因此一共需要三个RTT

QUIC握手，相当于同时进行TCP握手和TLS握手，且采用TLS1.3，只需要1个RTT就能完成连接建立和密匙协商

**在发送建立连接的帧时同时携带TLS握手的信息**

### 连接迁移

TCP通过四元组确定TCP连接，QUIC通过连接ID确立(QUIC握手生成ID)，连接ID标记通信两个端点，实现连接迁移