# HTTP/2

## 兼容HTTP/1.1

## 头部压缩

HTTP协议报文由**Header** + **Body** 构成，Body可以采用压缩算法，Header没有针对的优化手段

Header有很多固定字段，同时大量请求中很多**字段值是重复**的，字段为ASCII编码，对机器来说效率低

开发了**HPACK**算法压缩头部，分为三部分

- 静态字典

   为在头部高频出现的字段建立了一张静态表，根据索引取头部，或者头部加value，因为这个静态表在客户端和服务端两端建立的，传递时仅传递索引号（一个字节），之后在表中取出数据，就可以压缩数据，再加上Huffman编码压缩，有50%-90%的压缩率

- 动态字典

​    静态表只包含61中高频出现的头部字符串，不在静态表范围的头部字符串如果重复度出现就会自行构建动态表，服务端与客户端都维护各自的动态表，在第二次（同一个连接重复传完全相同的头部动态表才会建立）后的发送都只需要发送一个索引号即可

   但是动态表越大，占用内存越大，影响服务器性能，会提供http2_max_requests配置限制一个连接传输的请求数量。

- Huffman编码（压缩算法）

## 二进制帧

由文本格式改为二进制格式传输数据，效率会提高

对传输的报文进行了修改，划分为了两类帧（Fream），HEADERS和DATA帧

帧格式（帧头9字节）

![image-20240105143208962](https://s2.loli.net/2024/04/04/7Z3k9mBEzKhC8VO.png)

帧长度 帧数据的长度，

帧类型 数据帧（传递的是头数据，还是data数据，或者流的优先级）和控制帧（结束流，修改配置流等）

标志位 携带简单的控制信息

标识符 流的id Frame根据相同流id进行组装信息

## 并发传输

HTTP1.1队头阻塞，一应一答，想要并发传输，需要开启多个HTTP连接（浏览器一般限制最多6个），同时需要建立多次Tcp连接。

采用Stream，HTTP2实现了同一个TCP连接的复用，多个Stream在一条连接内传输，实现并发的效果

一个Steam通过Message传输，Message里包含多个Frame。

同一个Tcp连接，**不同Stream的帧可以乱序发送**，通过streamId有序组装，但同一Stream的帧必须有序

流还可以有**优先级**，可以控制资源的优先传输

## 服务端主动推送资源

如客户端访问HTML，服务端主动推送CSS，减少请求数

客户端请求流id为奇数，服务端主动推送流id为偶数

